<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bubble Level WebSocket</title>
<style>
  body { margin:0; background:#333; display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; color:white; font-family:sans-serif; }
  button { margin:10px; padding:10px 20px; font-size:18px; }
  canvas { background:#222; border:4px solid #555; border-radius:50%; }
  #status { margin-top:15px; font-size:22px; font-weight:bold; }
</style>
</head>
<body>
<button id="start">Enable Motion</button>
<button id="calibrate" style="display:none;">Calibrate</button>
<canvas id="canvas" width="300" height="300"></canvas>
<div id="status"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');
    const radius = canvas.width / 2;

    let x = 0, y = 0;
    let offsetGamma = 0, offsetBeta = 0;
    let lastState = "";
    let ws;

    const sensitivity = 15;

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // outer circle
        ctx.beginPath();
        ctx.arc(radius, radius, radius - 5, 0, Math.PI * 2);
        ctx.strokeStyle = "#aaa";
        ctx.lineWidth = 5;
        ctx.stroke();

        // crosshair
        ctx.strokeStyle = "#555";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(radius, 0); ctx.lineTo(radius, canvas.height);
        ctx.moveTo(0, radius); ctx.lineTo(canvas.width, radius);
        ctx.stroke();

        // bubble
        ctx.beginPath();
        ctx.arc(radius + x, radius + y, 20, 0, Math.PI * 2);
        ctx.fillStyle = "yellow";
        ctx.fill();
        ctx.strokeStyle = "#333";
        ctx.stroke();

        requestAnimationFrame(draw);
    }

    document.getElementById('start').addEventListener('click', async () => {
        if (typeof DeviceMotionEvent?.requestPermission === 'function') {
            const perm = await DeviceMotionEvent.requestPermission();
            if (perm !== 'granted') return alert('Permission denied');
        }
        if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
            const perm = await DeviceOrientationEvent.requestPermission();
            if (perm !== 'granted') return alert('Permission denied');
        }

        ws = new WebSocket("ws://192.168.0.104:8000"); // replace with your laptop IP
        ws.onopen = () => console.log("Connected to server");
        ws.onerror = e => console.error("WebSocket error", e);
        ws.onclose = () => console.log("Connection closed");

        window.addEventListener('deviceorientation', e => {
            const gamma = (e.gamma || 0) - offsetGamma;
            const beta = (e.beta || 0) - offsetBeta;

            x = (gamma / sensitivity) * (radius - 30);
            y = (beta / sensitivity) * (radius - 30);

            const max = radius - 30;
            x = Math.max(-max, Math.min(max, x));
            y = Math.max(-max, Math.min(max, y));

            // Use same logic as bubble for WebSocket
            let newState = (y < 0 ? "up" : "down");
            status.textContent = newState.charAt(0).toUpperCase() + newState.slice(1);

            if (newState !== lastState && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ button: newState }));
                lastState = newState;
            }
        });

        document.getElementById('start').style.display = 'none';
        document.getElementById('calibrate').style.display = 'inline-block';
        draw();
    });

    document.getElementById('calibrate').addEventListener('click', () => {
        const handler = e => {
            offsetGamma = e.gamma || 0;
            offsetBeta = e.beta || 0;
            window.removeEventListener('deviceorientation', handler);
        };
        window.addEventListener('deviceorientation', handler);
    });
});
</script>
</body>
</html>
